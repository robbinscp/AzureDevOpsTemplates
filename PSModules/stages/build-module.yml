parameters:
- name: ModuleName
  type: string

stages:
- stage: Build
  jobs:
    - job: Build
      steps:
        # https://github.com/PoshCode/Azure-Pipelines/blob/master/Install-RequiredModule-step.yml
        - powershell: |
            # Apparently, Install-Script isn't good enough except on Windows?
            # Install-Script Install-RequiredModule -Force -Verbose
            Save-Script Install-RequiredModule -Path '$(Pipeline.Workspace)'
            &"$(Pipeline.Workspace)/Install-RequiredModule" -Path '$(Build.SourcesDirectory)/RequiredModules.psd1' -Confirm:$false -Verbose
            foreach ($installErr in $IRM_InstallErrors) {
                Write-Warning "ERROR: $installErr"
                Write-Warning "STACKTRACE: $($installErr.ScriptStackTrace)"
            }
          displayName: 'Restore pre-requisites'
        - task: gitversion/setup@0
          inputs:
            versionSpec: '5.x'
        - task: gitversion/execute@0
        - powershell: |
            gci env:
        - powershell: |
            $version = '$(GitVersion.NuGetVersion)'
            if ((($split = $version.split('-')).Count -1) -gt 1) {
                $split.Count
                $version = $split[0] + '-' + ($split[1..($split.Count -1)] -join 'b')
            }
            Build-Module -OutputDirectory '$(Build.ArtifactStagingDirectory)\${{ parameters.ModuleName }}' -SemVer $version -Verbose
          displayName: 'Build Module'
        - publish: $(Build.ArtifactStagingDirectory)
          artifact: ${{ parameters.ModuleName }}
